name: ammp-edge
version: git
summary: Edge application for AMMP
description: |
    Manages data collection and forwarding for AMMP, the Asset Monitoring and Management Platform.
    https://www.ammp.io/
    https://github.com/ammpio/ammp-edge

grade: stable
confinement: strict

base: core22

architectures:
  - build-on: armhf
  - build-on: arm64

epoch: 1

apps:
  # Oneshot services don't support restart-on-failure
  # (see https://forum.snapcraft.io/t/restart-condition-not-respected-for-oneshot-systemd-service/)
  # So this needs to be provided for in the application itself
  ae-init:
    command: bin/ae init
    daemon: oneshot
    plugs: [network]
  mosquitto:
    command: bin/mosquitto_svc.sh
    daemon: simple
    restart-condition: always
    restart-delay: 2s
    after: [ae-init]
    plugs: [network, network-bind]
  ae-pub-meta:
    command: bin/ae mqtt-pub-meta
    daemon: oneshot
    after: [ae-init, mosquitto]
    plugs: [network]
  ae-sub-cfg-cmd:
    command: bin/ae mqtt-sub-cfg-cmd
    daemon: simple
    restart-condition: always
    restart-delay: 2s
    after: [ae-init, mosquitto]
    plugs: [network, network-bind, serial-port]
    environment:
    # The following is required in order to make libblas3 visible to nmap
      LD_LIBRARY_PATH: "$LD_LIBRARY_PATH:$SNAP/usr/lib/$CRAFT_ARCH_TRIPLET/blas"
  ammp-edge:
    command: bin/ammp_edge
    daemon: simple
    restart-condition: always
    restart-delay: 2s
    after: [ae-init, mosquitto]
    plugs:
      - network
      - network-bind
      - system-observe
      - hardware-observe
      - network-observe
      - serial-port
      - log-observe
    environment:
      LD_LIBRARY_PATH: "$LD_LIBRARY_PATH:$SNAP/usr/lib/$CRAFT_ARCH_TRIPLET/blas"
  web-ui:
    command: bin/python3 -m flask run
    daemon: simple
    restart-condition: always
    after: [ae-init]
    plugs:
      - network-bind
    environment:
      FLASK_APP: web_ui
      FLASK_RUN_HOST: 0.0.0.0
      FLASK_RUN_PORT: 8000
      LC_ALL: C.UTF-8
      LANG: C.UTF-8
      LD_LIBRARY_PATH: "$LD_LIBRARY_PATH:$SNAP/usr/lib/$CRAFT_ARCH_TRIPLET/blas"
  nmap:
    command: usr/bin/nmap
    environment:
      LD_LIBRARY_PATH: "$LD_LIBRARY_PATH:$SNAP/usr/lib/$CRAFT_ARCH_TRIPLET/blas"
    plugs: [network, network-bind, network-control]
  wifi-ap-control:
    command: bin/wifi_ap_control
    daemon: simple
    restart-condition: on-abnormal
    plugs: [network]
  env-scan:
    command: bin/env_scan_svc
    daemon: simple
    plugs: [network, network-observe]
    timer: 0:00~24:00/36
    environment:
      LD_LIBRARY_PATH: "$LD_LIBRARY_PATH:$SNAP/usr/lib/$CRAFT_ARCH_TRIPLET/blas"

parts:
  ammp-edge:
    plugin: python
    source: src
    build-packages:
      - libsnmp-dev
    build-environment:
      - PIP_EXTRA_INDEX_URL: https://ammplipy.ammp.io/
    stage-packages:
      - libsnmp40
      - nmap
    override-prime: |
      craftctl default
      "${CRAFT_PRIME}"/bin/python3 \
        -m compileall \
        -q \
        --workers 0 \
        "${CRAFT_PRIME}"
  configs:
    plugin: dump
    source: config
    prime:
      - mosquitto.conf.tpl
      - mqtt-bridge.conf.tpl
      - mqtt-bridge-stage.conf.tpl
  resources:
    plugin: dump
    source: resources
    organize:
      '*': resources/
    prime: [resources]
  drivers:
    plugin: dump
    source: drivers
    organize:
      '*': drivers/
    prime: [drivers]
  bin:
    plugin: dump
    source: bin
    organize:
      '*': bin/
    prime:
     - bin
  rust-deps:
    plugin: nil
    build-packages:
      - wget
    override-pull: |
      # Do not use rustup to work around https://forum.snapcraft.io/t/armhf-builds-on-launchpad-timing-out/31008
      REQUIRED_RUST_VERSION=nightly
      ROOT=https://static.rust-lang.org/dist/rust-$REQUIRED_RUST_VERSION
      if [ $SNAPCRAFT_TARGET_ARCH = "amd64" ]; then
        BINARIES_SUFFIX=x86_64-unknown-linux-gnu
      elif [ $SNAPCRAFT_TARGET_ARCH = "armhf" ]; then
        BINARIES_SUFFIX=armv7-unknown-linux-gnueabihf
      elif [ $SNAPCRAFT_TARGET_ARCH = "arm64" ]; then
        BINARIES_SUFFIX=aarch64-unknown-linux-gnu
      fi
      wget -O - $ROOT-$BINARIES_SUFFIX.tar.gz | tar -x -z --strip-components=1
      ./install.sh --prefix=/usr --destdir=$SNAPCRAFT_STAGE
  ae:
    plugin: rust
    source: rust
    after: [rust-deps]
    build-packages:
      - pkg-config
      - libsqlite3-dev
  envsubst:
    plugin: nil
    stage-packages:
     - gettext-base
    prime:
     - usr/bin/envsubst
  mosquitto:
    plugin: make
    make-parameters:
     - "prefix=/usr"
     - "WITH_DOCS=no"
     - "WITH_CJSON=no"
     - "WITH_ADNS=yes"
     - "CFLAGS='-Wall -ggdb -O2 -I$CRAFT_STAGE/include -D_GNU_SOURCE'"
    source: https://github.com/eclipse/mosquitto
    source-type: git
    source-tag: v2.0.14
    source-depth: 1
    build-packages:
      - libssl-dev
      - gcc
      - g++
    stage-packages:
      - libssl3
    prime:
      - usr/sbin/mosquitto
      - usr/lib/libmosquitto.so*
      - lib/*-linux-gnu/libcrypto.so*
      - lib/*-linux-gnu/libssl.so*
      - usr/include/mosquitto.h
      - usr/include/mosquitto_broker.h
      - usr/include/mosquitto_plugin.h
      - usr/include/mqtt_protocol.h

plugs:
  provisioning-edge:
    interface: content
    content: ammp-edge-provisioning
    target: $SNAP/provisioning
  wifi-ap-control:
    interface: content
    content: socket-directory
    target: $SNAP_DATA/sockets/wifi-ap
